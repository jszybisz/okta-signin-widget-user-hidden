{"version":3,"file":"BaseLoginRouter.js","sources":["../../../../src/v2/BaseLoginRouter.ts"],"sourcesContent":["/* eslint max-depth: [1,4] */\n/*!\n * Copyright (c) 2020, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n// BaseLoginRouter contains the more complicated router logic - rendering/\n// transition, etc. Most router changes should happen in LoginRouter (which is\n// responsible for adding new routes)\nimport { _, $, Backbone, Router, loc, BaseRouterOptions } from '@okta/courage';\nimport Settings from 'models/Settings';\nimport Bundles from 'util/Bundles';\nimport BrowserFeatures from 'util/BrowserFeatures';\nimport ColorsUtil from 'util/ColorsUtil';\nimport Enums from 'util/Enums';\nimport { ConfigError } from 'util/Errors';\nimport Logger from 'util/Logger';\nimport LanguageUtil from 'util/LanguageUtil';\nimport AuthContainer from 'v1/views/shared/AuthContainer';\nimport Header from 'v1/views/shared/Header';\nimport AppState from './models/AppState';\nimport sessionStorageHelper from './client/sessionStorageHelper';\nimport {\n  startLoginFlow,\n  handleConfiguredFlow,\n  updateAppState,\n} from './client';\n\nimport CookieUtil from 'util/CookieUtil';\nimport { formatError, LegacyIdxError, StandardApiError } from './client/formatError';\nimport { RenderError, RenderResult } from 'types';\nimport { OktaAuth, IdxResponse } from '@okta/okta-auth-js';\nimport Hooks from 'models/Hooks';\nimport IonHelper from './ion/IonResponseHelper';\n\nexport interface BaseLoginRouterOptions extends BaseRouterOptions, Backbone.RouterOptions {\n  globalSuccessFn?: (res: RenderResult) => void;\n  globalErrorFn?: (res: RenderError) => void;\n  authClient?: OktaAuth;\n  hooks: Hooks\n}\n\nclass BaseLoginRouter extends Router<Settings, BaseLoginRouterOptions> {\n  Events: Backbone.Events = Backbone.Events; // also set on prototype\n  hasControllerRendered = false;\n  settings: Settings;\n  appState: AppState;\n  hooks: Hooks;\n  header: Header;\n\n  constructor(options: BaseLoginRouterOptions) {\n    super(options);\n\n    // Create a default success and/or error handler if\n    // one is not provided.\n    if (!options.globalSuccessFn) {\n      options.globalSuccessFn = function() { /* dummy function */ };\n    }\n    if (!options.globalErrorFn) {\n      options.globalErrorFn = function(err) {\n        Logger.error(err);\n      };\n    }\n\n    this.settings = new Settings(_.omit(options, 'el', 'hooks'), { parse: true });\n\n    if (!options.el) {\n      this.settings.callGlobalError(new ConfigError(loc('error.required.el')));\n    }\n\n    $('body > div').on('click', function() {\n      // OKTA-69769 Tooltip wont close on iPhone/iPad\n      // Registering a click handler on the first div\n      // allows a tap that falls outside the tooltip\n      // to be registered as a tap by iOS\n      // and then the open tooltip will lose focus and close.\n    });\n\n    this.hooks = options.hooks;\n    this.appState = new AppState({}, {\n      settings: this.settings,\n      hooks: this.hooks\n    });\n\n    const wrapper = new AuthContainer({ appState: this.appState });\n\n    $(options.el).append(wrapper.render().$el);\n    this.el = `#${Enums.WIDGET_CONTAINER_ID}`;\n    this.header = new Header({\n      el: this.el,\n      appState: this.appState,\n      settings: this.settings,\n    });\n\n    // Hide until unitial render\n    this.hide();\n\n    this.listenTo(this.appState, 'change:deviceFingerprint', this.updateDeviceFingerprint);\n    this.listenTo(this.appState, 'restartLoginFlow', this.restartLoginFlow);\n  }\n\n  updateDeviceFingerprint() {\n    const authClient = this.settings.getAuthClient();\n    const fingerprint = this.appState.get('deviceFingerprint');\n    if (fingerprint) {\n      authClient.http.setRequestHeader('X-Device-Fingerprint', fingerprint);\n    }\n  }\n\n  async handleIdxResponseFailure(error: LegacyIdxError = { error: 'unknown', details: undefined }) {\n    // IDX errors will not call the global error handler\n    error = formatError(error);\n    await updateAppState(this.appState, error.details);\n  }\n\n  // Generic error handler for all exceptions\n  async handleError(error: LegacyIdxError | StandardApiError | Error = { error: 'unknown', details: undefined }) {\n    const formattedError = formatError({...error}); // format the error to resemble an IDX response\n    await updateAppState(this.appState, formattedError.details);\n  }\n\n  /* eslint max-statements: [2, 36], complexity: [2, 16] */\n  async render(Controller, options = {}) {\n    // If url changes then widget assumes that user's intention was to initiate a new login flow,\n    // so clear stored token to use the latest token.\n    if (sessionStorageHelper.getLastInitiatedLoginUrl() !== window.location.href) {\n      sessionStorageHelper.removeStateHandle();\n    }\n    // Since we have a wrapper view, render our wrapper and use its content\n    // element as our new el.\n    // Note: Render it here because we know dom is ready at this point\n    if (!this.header.rendered()) {\n      this.el = this.header.render().getContentEl();\n    }\n\n    // If we need to load a language (or apply custom i18n overrides), do\n    // this now and re-run render after it's finished.\n    if (!Bundles.isLoaded(this.settings.get('languageCode'))) {\n      await LanguageUtil.loadLanguage(this.appState, this.settings);\n    }\n\n    let error;\n    try {\n      let idxResp = await startLoginFlow(this.settings);\n      if (idxResp.error) {\n        await this.handleIdxResponseFailure(idxResp.error);\n      } else {\n        if (this.settings.get('flow') && !this.hasControllerRendered) {\n          idxResp = await handleConfiguredFlow(idxResp, this.settings);\n        }\n\n        // TODO: OKTA-494979 - temporary fix, remove when auth-js is upgraded to 6.6+\n        if (!idxResp.requestDidSucceed && IonHelper.isIdxSessionExpiredError(idxResp)) {\n          // clear transaction subsequent page loads do not use stale interactionHandle\n          const authClient = this.settings.getAuthClient();\n          authClient.transactionManager.clear();\n        }\n\n        await updateAppState(this.appState, idxResp);\n      }\n    } catch (exception) {\n      if (exception.is?.('terminal')) {\n        this.appState.setNonIdxError(exception);\n      } else {\n        error = exception;\n        await this.handleError(exception);\n      }\n    } finally {\n      // These settings should only be used one time, for initial render\n      this.settings.unset('stateToken');\n      this.settings.unset('proxyIdxResponse');\n    }\n\n    // Load the custom colors only on the first render\n    if (this.settings.get('colors.brand') && !ColorsUtil.isLoaded()) {\n      const colors = {\n        brand: this.settings.get('colors.brand'),\n      };\n      const cspNonce = this.settings.get('cspNonce');\n\n      ColorsUtil.addStyle(colors, cspNonce);\n    }\n\n    // Show before initial render\n    this.show();\n\n    // render Controller\n    this.unload();\n    const controllerOptions = _.extend({\n      el: this.el,\n      settings: this.settings,\n      appState: this.appState\n    }, options);\n    this.controller = new Controller(controllerOptions);\n\n    // Bubble up all controller events\n    this.listenTo(this.controller, 'all', this.trigger);\n\n    this.controller.render();\n\n    this.hasControllerRendered = true;\n\n    // This will reject the promise returned from renderEl\n    if (error) {\n      this.settings.callGlobalError(error);\n    }\n\n    // -- TODO: OKTA-244631 How to surface up the CORS error in IDX?\n    // -- The `err` object from idx.js doesn't have XHR object\n    // Global error handling for CORS enabled errors\n    // if (err.xhr && BrowserFeatures.corsIsNotEnabled(err.xhr)) {\n    //   this.settings.callGlobalError(new UnsupportedBrowserError(loc('error.enabled.cors')));\n    //   return;\n    // }\n  }\n\n  /**\n    * When \"Remember My Username\" is enabled, we save the identifier in a cookie\n    * so that the next time the user visits the SIW, the identifier field can be \n    * pre-filled with this value.\n   */\n  updateIdentifierCookie(idxResponse: IdxResponse) {\n    if (this.settings.get('features.rememberMe')) {\n      // Update the cookie with the identifier\n      const user = idxResponse?.context?.user;\n      const { identifier } = user?.value || {};\n      if (identifier) {\n        CookieUtil.setUsernameCookie(identifier);\n      }\n    } else {\n      // We remove the cookie explicitly if this feature is disabled.\n      CookieUtil.removeUsernameCookie();\n    }    \n  }\n\n  hasAuthenticationSucceeded(idxResponse: IdxResponse) {\n    // Check whether authentication has succeeded. This is done by checking the server response\n    // and seeing if either the 'success' or 'successWithInteractionCode' objects are present.\n    return idxResponse?.rawIdxState?.success || idxResponse?.rawIdxState?.successWithInteractionCode;\n  }\n\n  restartLoginFlow(flow) {\n    // clear all transaction data and saved IDX response\n    this.settings.getAuthClient().transactionManager.clear();\n    this.appState.set('idx', undefined);\n\n    // Clear the recoveryToken, if any\n    const authClient = this.settings.getAuthClient();\n    delete authClient.options['recoveryToken'];\n    this.settings.unset('recoveryToken');\n    // clear otp (email magic link), if any\n    this.settings.unset('otp');\n\n    // remove all event listeners from current controller instance. A new instance will be created in render().\n    this.controller.stopListening();\n\n    authClient.idx.setFlow(flow ?? this.settings.get('flow') ?? 'default');\n\n    // Re-render the widget\n    this.render(this.controller.constructor);\n  }\n\n  start() {\n    const pushState = BrowserFeatures.supportsPushState();\n    Router.prototype.start.call(this, { pushState: pushState });\n  }\n\n  hide() {\n    this.header.$el.hide();\n  }\n\n  show() {\n    this.header.$el.show();\n  }\n\n  remove() {\n    this.unload();\n    this.header.$el.remove();\n    this.stopListening(this.appState);\n    this.stopListening(this.settings);\n    Bundles.remove();\n    Backbone.history.stop();\n  }\n}\n\n// Add \"Events\" to prototype for compatibility with existing code\nBaseLoginRouter.prototype.Events = Backbone.Events;\n\nexport default BaseLoginRouter;\n"],"names":["BaseLoginRouter","Router","constructor","options","Events","Backbone","hasControllerRendered","settings","appState","hooks","header","globalSuccessFn","globalErrorFn","err","Logger","error","Settings","_","omit","parse","el","callGlobalError","ConfigError","loc","$","on","AppState","wrapper","AuthContainer","append","render","$el","Enums","WIDGET_CONTAINER_ID","Header","hide","listenTo","updateDeviceFingerprint","restartLoginFlow","authClient","getAuthClient","fingerprint","get","http","setRequestHeader","handleIdxResponseFailure","details","undefined","formatError","updateAppState","handleError","formattedError","Controller","sessionStorageHelper","getLastInitiatedLoginUrl","window","location","href","removeStateHandle","rendered","getContentEl","Bundles","isLoaded","LanguageUtil","loadLanguage","idxResp","startLoginFlow","handleConfiguredFlow","requestDidSucceed","IonHelper","isIdxSessionExpiredError","transactionManager","clear","exception","_exception$is","is","call","setNonIdxError","unset","ColorsUtil","colors","brand","cspNonce","addStyle","show","unload","controllerOptions","extend","controller","trigger","updateIdentifierCookie","idxResponse","_idxResponse$context","user","context","identifier","value","CookieUtil","setUsernameCookie","removeUsernameCookie","hasAuthenticationSucceeded","_idxResponse$rawIdxSt","_idxResponse$rawIdxSt2","rawIdxState","success","successWithInteractionCode","flow","_ref","set","stopListening","idx","setFlow","start","pushState","BrowserFeatures","supportsPushState","prototype","remove","history","stop"],"mappings":"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"}