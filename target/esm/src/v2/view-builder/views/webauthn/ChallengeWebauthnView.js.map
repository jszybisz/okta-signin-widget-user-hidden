{"version":3,"file":"ChallengeWebauthnView.js","sources":["../../../../../../../src/v2/view-builder/views/webauthn/ChallengeWebauthnView.js"],"sourcesContent":["import { _, loc, createButton, createCallout } from '@okta/courage';\nimport { BaseForm } from '../../internals';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport CryptoUtil from '../../../../util/CryptoUtil';\nimport webauthn from '../../../../util/webauthn';\nimport BrowserFeatures from '../../../../util/BrowserFeatures';\nimport ChallengeWebauthnInfoView from './ChallengeWebauthnInfoView';\nimport { getMessageFromBrowserError } from '../../../ion/i18nTransformer';\nimport ChallengeWebauthnFooter from '../../components/ChallengeWebauthnFooter';\nimport { FORMS as RemediationForms } from '../../../ion/RemediationConstants';\nimport EnrollWebAuthnResidentKeyLinkView from './EnrollWebAuthnResidentkeyLinkView';\n\nconst Body = BaseForm.extend({\n\n  title() {\n    return loc('oie.verify.webauth.title', 'login');\n  },\n\n  className: 'oie-verify-webauthn',\n\n  getUISchema() {\n    const schema = [];\n    // Returning custom array so no input fields are displayed for webauthn\n    if (webauthn.isNewApiAvailable()) {\n      const retryButton = createButton({\n        className: 'retry-webauthn button-primary default-custom-button',\n        title: loc('mfa.challenge.verify', 'login'),\n        click: () => {\n          this.getCredentialsAndSave();\n        }\n      });\n\n      schema.push({\n        View: ChallengeWebauthnInfoView,\n      }, {\n        View: retryButton,\n      });\n      if (this._canSetupWebAuthnResidentKey()) {\n        schema.push({View: EnrollWebAuthnResidentKeyLinkView});\n      }\n    } else {\n      schema.push({\n        View: createCallout({\n          className: 'webauthn-not-supported',\n          type: 'error',\n          subtitle: loc('oie.webauthn.error.not.supported', 'login'),\n        }),\n      });\n    }\n    return schema;\n  },\n\n  remove() {\n    BaseForm.prototype.remove.apply(this, arguments);\n    if (this.webauthnAbortController) {\n      this.webauthnAbortController.abort();\n      this.webauthnAbortController = null;\n    }\n  },\n\n  noButtonBar: true,\n\n  modelEvents: {\n    'error': '_stopVerification'\n  },\n\n  getCredentialsAndSave() {\n    this.clearErrors();\n    this._startVerification();\n    // AbortController is not supported in IE11\n    if (typeof AbortController !== 'undefined') {\n      this.webauthnAbortController = new AbortController();\n    }\n    const relatesToObject = this.options.currentViewState.relatesTo;\n    const authenticatorData = relatesToObject?.value || {};\n    const allowCredentials = [];\n    const authenticatorEnrollments = this.options.appState.get('authenticatorEnrollments')?.value || [];\n    authenticatorEnrollments.forEach((enrollement) => {\n      if (enrollement.key === 'webauthn') {\n        allowCredentials.push({\n          type: 'public-key',\n          id: CryptoUtil.strToBin(enrollement.credentialId),\n        });\n      }\n    });\n    const challengeData = authenticatorData.contextualData.challengeData;\n    const options = _.extend({}, challengeData, {\n      allowCredentials,\n      challenge: CryptoUtil.strToBin(challengeData.challenge),\n    });\n    // navigator.credentials() is not supported in IE11\n    // eslint-disable-next-line compat/compat\n    navigator.credentials.get({\n      publicKey: options,\n      signal: this.webauthnAbortController && this.webauthnAbortController.signal\n    }).then((assertion) => {\n      const credentials = {\n        clientData: CryptoUtil.binToStr(assertion.response.clientDataJSON),\n        authenticatorData: CryptoUtil.binToStr(assertion.response.authenticatorData),\n        signatureData: CryptoUtil.binToStr(assertion.response.signature)\n      };\n      const hasUserHandleSchema = this.options.appState.getSchemaByName('credentials.userHandle');\n      if (hasUserHandleSchema) {\n        _.extend(credentials, {\n          userHandle: CryptoUtil.binToStr(assertion.response.userHandle ?? '')\n        });\n      }\n      \n      this.model.set({\n        credentials\n      });\n      this.saveForm(this.model);\n    }, (error) => {\n      // Do not display if it is abort error triggered by code when switching.\n      // this.webauthnAbortController would be null if abort was triggered by code.\n      if (this.webauthnAbortController) {\n        this.model.trigger('error', this.model, {responseJSON: {errorSummary: getMessageFromBrowserError(error)}});\n      }\n    }).finally(() => {\n      // unset webauthnAbortController on successful authentication or error\n      this.webauthnAbortController = null;\n    });\n  },\n\n  _startVerification: function() {\n    this.$('.okta-waiting-spinner').show();\n    this.$('.retry-webauthn').hide();\n    this.$('.setup-webauthn-residentkey-text').hide();\n    this.$('.retry-webauthn')[0].textContent = loc('retry', 'login');\n  },\n\n  _stopVerification: function() {\n    this.$('.okta-waiting-spinner').hide();\n    this.$('.retry-webauthn').show();\n    this.$('.setup-webauthn-residentkey-text').show();\n  },\n\n  _canSetupWebAuthnResidentKey: function() {\n    return this.options.appState.hasRemediationObject(RemediationForms.ENROLL_WEBAUTHN_RESIDENTKEY);\n  }\n});\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n  Footer: ChallengeWebauthnFooter,\n  postRender() {\n    BaseAuthenticatorView.prototype.postRender.apply(this, arguments);\n    // Trigger browser prompt automatically for other browsers for better UX.\n    if (webauthn.isNewApiAvailable() && !BrowserFeatures.isSafari()) {\n      this.form.getCredentialsAndSave();\n    }\n  },\n});\n"],"names":["Body","BaseForm","extend","title","loc","className","getUISchema","schema","webauthn","isNewApiAvailable","retryButton","createButton","click","getCredentialsAndSave","push","View","ChallengeWebauthnInfoView","_canSetupWebAuthnResidentKey","EnrollWebAuthnResidentKeyLinkView","createCallout","type","subtitle","remove","prototype","apply","arguments","webauthnAbortController","abort","noButtonBar","modelEvents","_this$options$appStat","clearErrors","_startVerification","AbortController","relatesToObject","options","currentViewState","relatesTo","authenticatorData","value","allowCredentials","authenticatorEnrollments","appState","get","forEach","enrollement","key","id","CryptoUtil","strToBin","credentialId","challengeData","contextualData","_","challenge","navigator","credentials","publicKey","signal","then","assertion","clientData","binToStr","response","clientDataJSON","signatureData","signature","hasUserHandleSchema","getSchemaByName","_assertion$response$u","userHandle","model","set","saveForm","error","trigger","responseJSON","errorSummary","getMessageFromBrowserError","finally","$","show","hide","textContent","_stopVerification","hasRemediationObject","RemediationForms","ENROLL_WEBAUTHN_RESIDENTKEY","BaseAuthenticatorView","Footer","ChallengeWebauthnFooter","postRender","BrowserFeatures","isSafari","form"],"mappings":"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"}