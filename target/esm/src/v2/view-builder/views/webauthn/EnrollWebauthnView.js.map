{"version":3,"file":"EnrollWebauthnView.js","sources":["../../../../../../../src/v2/view-builder/views/webauthn/EnrollWebauthnView.js"],"sourcesContent":["import { _, loc, createCallout, createButton } from '@okta/courage';\nimport { BaseForm } from '../../internals';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport webauthn from 'util/webauthn';\nimport CryptoUtil from 'util/CryptoUtil';\nimport EnrollWebauthnInfoView from './EnrollWebauthnInfoView';\nimport { getMessageFromBrowserError } from '../../../ion/i18nTransformer';\n\nfunction getExcludeCredentials(authenticatorEnrollments = []) {\n  const credentials = [];\n  authenticatorEnrollments.forEach((enrollement) => {\n    if (enrollement.key === 'webauthn') {\n      credentials.push({\n        type: 'public-key',\n        id: CryptoUtil.strToBin(enrollement.credentialId),\n      });\n    }\n  });\n  return credentials;\n}\n\nconst Body = BaseForm.extend({\n  title() {\n    return loc('oie.enroll.webauthn.title', 'login');\n  },\n  className: 'oie-enroll-webauthn',\n  modelEvents: {\n    'error': '_stopEnrollment',\n  },\n  getUISchema() {\n    const schema = [];\n    // Returning custom array so no input fields are displayed for webauthn\n    if (webauthn.isNewApiAvailable()) {\n      schema.push({\n        View: EnrollWebauthnInfoView,\n      });\n      schema.push({\n        View: createButton({\n          className: 'webauthn-setup button button-primary button-wide',\n          title: loc('oie.enroll.webauthn.save', 'login'),\n          click: () => {\n            this.triggerWebauthnPrompt();\n          },\n        }),\n      });\n    } else {\n      schema.push({\n        View: createCallout({\n          className: 'webauthn-not-supported',\n          type: 'error',\n          subtitle: loc('oie.webauthn.error.not.supported', 'login'),\n        }),\n      });\n    }\n    return schema;\n  },\n  triggerWebauthnPrompt() {\n    this.$el.find('.o-form-error-container').empty();\n    this._startEnrollment();\n    const relatesToObject = this.options.currentViewState.relatesTo;\n    const activationData = relatesToObject?.value.contextualData.activationData;\n    if (webauthn.isNewApiAvailable()) {\n      const excludeCredentials = activationData.authenticatorSelection?.requireResidentKey === true ?\n        [] :\n        getExcludeCredentials(this.options.appState.get('authenticatorEnrollments').value);\n      const options = _.extend({}, activationData, {\n        challenge: CryptoUtil.strToBin(activationData.challenge),\n        user: {\n          id: CryptoUtil.strToBin(activationData.user.id),\n          name: activationData.user.name,\n          displayName: activationData.user.displayName\n        },\n        excludeCredentials\n      });\n      // AbortController is not supported in IE11\n      if (typeof AbortController !== 'undefined') {\n        this.webauthnAbortController = new AbortController();\n      }\n      navigator.credentials.create({\n        publicKey: options,\n        signal: this.webauthnAbortController && this.webauthnAbortController.signal\n      }).then((newCredential) => {\n        this.model.set({\n          credentials : {\n            clientData: CryptoUtil.binToStr(newCredential.response.clientDataJSON),\n            attestation: CryptoUtil.binToStr(newCredential.response.attestationObject),\n            // example data: [\"nfc\", \"usb\"]\n            transports: webauthn.processWebAuthnResponse(newCredential.response.getTransports, newCredential.response),\n            // example data: {\"credProps\":{\"rk\":true}}\n            clientExtensions: webauthn.processWebAuthnResponse(newCredential.getClientExtensionResults, newCredential)\n          }\n        });\n        this.saveForm(this.model);\n      })\n        .catch((error) => {\n          this.model.trigger('error', this.model, {responseJSON: {errorSummary: getMessageFromBrowserError(error)}});\n        }).finally(() => {\n          this.webauthnAbortController = null;\n        });\n    }\n  },\n  _startEnrollment: function() {\n    this.$('.okta-waiting-spinner').show();\n    this.$('.webauthn-setup').hide();\n  },\n\n  _stopEnrollment: function() {\n    this.$('.okta-waiting-spinner').hide();\n    this.$('.webauthn-setup').show();\n  },\n});\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n  postRender() {\n    BaseAuthenticatorView.prototype.postRender.apply(this, arguments);\n    this.$el.find('.o-form-button-bar [type=\"submit\"]').remove();\n  },\n});\n"],"names":["getExcludeCredentials","authenticatorEnrollments","credentials","forEach","enrollement","key","push","type","id","CryptoUtil","strToBin","credentialId","Body","BaseForm","extend","title","loc","className","modelEvents","getUISchema","schema","webauthn","isNewApiAvailable","View","EnrollWebauthnInfoView","createButton","click","triggerWebauthnPrompt","createCallout","subtitle","$el","find","empty","_startEnrollment","relatesToObject","options","currentViewState","relatesTo","activationData","value","contextualData","_activationData$authe","excludeCredentials","authenticatorSelection","requireResidentKey","appState","get","_","challenge","user","name","displayName","AbortController","webauthnAbortController","navigator","create","publicKey","signal","then","newCredential","model","set","clientData","binToStr","response","clientDataJSON","attestation","attestationObject","transports","processWebAuthnResponse","getTransports","clientExtensions","getClientExtensionResults","saveForm","catch","error","trigger","responseJSON","errorSummary","getMessageFromBrowserError","finally","$","show","hide","_stopEnrollment","BaseAuthenticatorView","postRender","prototype","apply","arguments","remove"],"mappings":"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"}