{"version":3,"file":"EndUserRemediationMessageViewUtil.js","sources":["../../../../../../src/v2/view-builder/utils/EndUserRemediationMessageViewUtil.js"],"sourcesContent":["/*!\n * Copyright (c) 2024, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\nimport { $ } from '@okta/courage';\nimport Enums from 'util/Enums';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport Logger from 'util/Logger';\nimport Util from 'util/Util';\nimport { getMessage } from '../../ion/i18nTransformer';\n\nconst PROBE_PATH = 'probe';\n// eslint-disable-next-line max-len\nconst ADP_INSTALL_FALLBACK_REMEDIATION_KEY = 'idx.error.code.access_denied.device_assurance.remediation.android.zero.trust.android_device_policy_app_required_manual_install';\n\nconst ajaxRequest = (requestOptions) => {\n  const ajaxOptions = Object.assign({\n    method: 'GET',\n    contentType: 'application/json',\n  }, requestOptions);\n  return $.ajax(ajaxOptions);\n};\n\nconst checkPort = (url, probeTimeoutMillis) => {\n  return ajaxRequest({\n    url: url,\n    timeout: probeTimeoutMillis\n  });\n};\n\nconst onPortFound = (url, timeout) => {\n  return ajaxRequest({\n    url: url,\n    method: 'GET',\n    timeout: timeout,\n  });\n};\n\nconst getFallbackMessage = (fallbackObj) => {\n  switch (fallbackObj.message.i18n.key) {\n  case ADP_INSTALL_FALLBACK_REMEDIATION_KEY:\n    // ADP fallback message has additional formatting\n    // eslint-disable-next-line max-len\n    return hbs`{{i18n code=\"idx.error.code.access_denied.device_assurance.remediation.android.zero.trust.android_device_policy_app_required_manual_install\"\n      bundle=\"login\"\n      $1=\"<span class='strong'>$1</span>\"\n    }}`();\n  default:\n    return getMessage(fallbackObj.message);\n  }\n};\n\nconst executeDeviceRemediationFallback = (fallback, action) => {\n  switch (fallback.type) {\n  case 'APP_LINK': {\n    // If/When loopback fails auto launch app link to install\n    Util.executeOnVisiblePage(() => {\n      Util.redirect(fallback.href, window, true);\n    });\n    break;\n  }\n  case 'MESSAGE': {\n    // display updated message in place\n    const siwContainer = document.getElementById(Enums.WIDGET_CONTAINER_ID);\n    if (!siwContainer) {\n      Logger.error('Cannot find okta-sign-in container to display message');\n      return;\n    }\n    const remediationMsgElements = siwContainer.querySelectorAll(`[data-se=\"${action}\"]`);\n    if (remediationMsgElements && remediationMsgElements[0]) {\n      remediationMsgElements[0].outerHTML = getFallbackMessage(fallback);\n    }\n    break;\n  }}\n};\n\nconst probe = (baseUrl, probeDetails) => {\n  return checkPort(`${baseUrl}/${PROBE_PATH}`, probeDetails.probeTimeoutMillis)\n    .then(() => {\n      const loopbackRemediationPath = `${baseUrl}/${probeDetails.remediationPath}/${probeDetails.actionPath}`;\n      return onPortFound(loopbackRemediationPath, probeDetails.probeTimeoutMillis)\n        .then(() => {\n          probeDetails.isSuccess = true;\n        });\n    })\n    .catch(() => {\n      Logger.error(`Something unexpected happened while we were checking url: ${baseUrl}.`);\n      return $.Deferred().reject();\n    });\n};\n\nexport const hasDeviceRemediationAction = (message) => {\n  return message.deviceRemediation\n    && message.deviceRemediation.value\n    && message.deviceRemediation.value.action;\n};\n\nexport const isLoopbackDeviceRemediation = (deviceRemediation) => {\n  return deviceRemediation && deviceRemediation.remediationType === 'LOOPBACK';\n};\n\nexport const probeLoopbackAndExecute = (deviceRemediation) => {\n  const domain = deviceRemediation.domain;\n  const ports = deviceRemediation.ports;\n  const totalPortCount = ports.length;\n  let failedPortCount = 0;\n  const probeDetails = {\n    remediationPath: deviceRemediation.remediationPath,\n    actionPath:  deviceRemediation.action,\n    probeTimeoutMillis: deviceRemediation.probeTimeoutMillis,\n    isSuccess: false,\n  };\n\n  let probeChain = Promise.resolve();\n  const baseUrls = ports.map((port) => `${domain}:${port}`);\n  baseUrls.forEach(baseUrl => {\n    // no need to continue if we found the port and made a successful request\n    if (probeDetails.isSuccess) {\n      return;\n    }\n    probeChain = probeChain.then(() => probe(baseUrl, probeDetails)).catch(() => {\n      failedPortCount += 1;\n      Logger.error(`Authenticator is not listening on: ${baseUrl}.`);\n      if (failedPortCount >= totalPortCount && !probeDetails.isSuccess) {\n        Logger.error('No available ports. Loopback server failed and using fallback mechanism.');\n        executeDeviceRemediationFallback(deviceRemediation.fallback, deviceRemediation.action);\n      }\n    });\n  });\n};\n"],"names":["PROBE_PATH","ADP_INSTALL_FALLBACK_REMEDIATION_KEY","ajaxRequest","requestOptions","ajaxOptions","Object","assign","method","contentType","$","ajax","checkPort","url","probeTimeoutMillis","timeout","onPortFound","getFallbackMessage","fallbackObj","message","i18n","key","_Handlebars2","template","main","container","depth0","helpers","partials","data","lookupProperty","parent","propertyName","prototype","hasOwnProperty","call","undefined","escapeExpression","hooks","helperMissing","nullContext","getMessage","executeDeviceRemediationFallback","fallback","action","type","Util","executeOnVisiblePage","redirect","href","window","siwContainer","document","getElementById","Enums","WIDGET_CONTAINER_ID","Logger","error","remediationMsgElements","querySelectorAll","outerHTML","probe","baseUrl","probeDetails","then","loopbackRemediationPath","remediationPath","actionPath","isSuccess","catch","Deferred","reject","hasDeviceRemediationAction","deviceRemediation","value","isLoopbackDeviceRemediation","remediationType","probeLoopbackAndExecute","domain","ports","totalPortCount","length","failedPortCount","probeChain","Promise","resolve","baseUrls","map","port","forEach"],"mappings":";;;;;;;;;;;;;;;;AAkBA,MAAMA,UAAU,GAAG,OAAO,CAAA;AAC1B;AACA,MAAMC,oCAAoC,GAAG,gIAAgI,CAAA;AAE7K,MAAMC,WAAW,GAAIC,cAAc,IAAK;AACtC,EAAA,MAAMC,WAAW,GAAGC,MAAM,CAACC,MAAM,CAAC;AAChCC,IAAAA,MAAM,EAAE,KAAK;AACbC,IAAAA,WAAW,EAAE,kBAAA;GACd,EAAEL,cAAc,CAAC,CAAA;AAClB,EAAA,OAAOM,gBAAC,CAACC,IAAI,CAACN,WAAW,CAAC,CAAA;AAC5B,CAAC,CAAA;AAED,MAAMO,SAAS,GAAGA,CAACC,GAAG,EAAEC,kBAAkB,KAAK;AAC7C,EAAA,OAAOX,WAAW,CAAC;AACjBU,IAAAA,GAAG,EAAEA,GAAG;AACRE,IAAAA,OAAO,EAAED,kBAAAA;AACX,GAAC,CAAC,CAAA;AACJ,CAAC,CAAA;AAED,MAAME,WAAW,GAAGA,CAACH,GAAG,EAAEE,OAAO,KAAK;AACpC,EAAA,OAAOZ,WAAW,CAAC;AACjBU,IAAAA,GAAG,EAAEA,GAAG;AACRL,IAAAA,MAAM,EAAE,KAAK;AACbO,IAAAA,OAAO,EAAEA,OAAAA;AACX,GAAC,CAAC,CAAA;AACJ,CAAC,CAAA;AAED,MAAME,kBAAkB,GAAIC,WAAW,IAAK;AAC1C,EAAA,QAAQA,WAAW,CAACC,OAAO,CAACC,IAAI,CAACC,GAAG;AACpC,IAAA,KAAKnB,oCAAoC;AACvC;AACA;MACA,OAAOoB,YAAA,CAAAC,QAAA,CAAA;AAAA,QAAA,UAAA,EAAA,CAAA,CAAA,EAAA,UAAA,CAAA;QAAA,MAAAC,EAAAA,UAAAC,SAAA,EAAAC,MAAA,EAAAC,OAAA,EAAAC,QAAA,EAAAC,IAAA,EAAA;UAAA,IAAAC,cAAA,GAAAL,SAAA,CAAAK,cAAA,IAAAC,UAAAA,MAAA,EAAAC,YAAA,EAAA;YAAA,IAAA1B,MAAA,CAAA2B,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAJ,MAAA,EAAAC,YAAA,CAAA,EAAA;cAAA,OAAAD,MAAA,CAAAC,YAAA,CAAA,CAAA;AAAA,aAAA;AAAA,YAAA,OAAAI,SAAA,CAAA;AAAA,WAAA,CAAA;AAAA,UAAA,OAAAX,SAAA,CAAAY,gBAAA,CAAA,CAAAP,cAAA,CAAAH,OAAA,EAAA,MAAA,CAAA,IAAAD,MAAA,IAAAI,cAAA,CAAAJ,MAAA,EAAA,MAAA,CAAA,IAAAD,SAAA,CAAAa,KAAA,CAAAC,aAAA,EAAAJ,IAAA,CAAAT,MAAA,IAAA,IAAA,GAAAA,MAAA,GAAAD,SAAA,CAAAe,WAAA,IAAA,EAAA,EAAA;AAAA,YAAA,MAAA,EAAA,MAAA;AAAA,YAAA,MAAA,EAAA;AAAA,cAAA,IAAA,EAAA,gCAAA;AAAA,cAAA,QAAA,EAAA,OAAA;AAAA,cAAA,MAAA,EAAA,gIAAA;AAAA,aAAA;AAAA,YAAA,MAAA,EAAAX,IAAA;AAAA,YAAA,KAAA,EAAA;AAAA,cAAA,OAAA,EAAA;AAAA,gBAAA,MAAA,EAAA,CAAA;AAAA,gBAAA,QAAA,EAAA,CAAA;AAAA,eAAA;AAAA,cAAA,KAAA,EAAA;AAAA,gBAAA,MAAA,EAAA,CAAA;AAAA,gBAAA,QAAA,EAAA,GAAA;AAAA,eAAA;AAAA,aAAA;AAAA,WAAA,CAAA,CAAA,CAAA;AAAA,SAAA;AAAA,QAAA,SAAA,EAAA,IAAA;AAAA,OAAA,CAAA,EAGF,CAAA;AACP,IAAA;AACE,MAAA,OAAOY,UAAU,CAACvB,WAAW,CAACC,OAAO,CAAC,CAAA;AACxC,GAAA;AACF,CAAC,CAAA;AAED,MAAMuB,gCAAgC,GAAGA,CAACC,QAAQ,EAAEC,MAAM,KAAK;EAC7D,QAAQD,QAAQ,CAACE,IAAI;AACrB,IAAA,KAAK,UAAU;AAAE,MAAA;AACf;QACAC,IAAI,CAACC,oBAAoB,CAAC,MAAM;UAC9BD,IAAI,CAACE,QAAQ,CAACL,QAAQ,CAACM,IAAI,EAAEC,MAAM,EAAE,IAAI,CAAC,CAAA;AAC5C,SAAC,CAAC,CAAA;AACF,QAAA,MAAA;AACF,OAAA;AACA,IAAA,KAAK,SAAS;AAAE,MAAA;AACd;QACA,MAAMC,YAAY,GAAGC,QAAQ,CAACC,cAAc,CAACC,KAAK,CAACC,mBAAmB,CAAC,CAAA;QACvE,IAAI,CAACJ,YAAY,EAAE;AACjBK,UAAAA,MAAM,CAACC,KAAK,CAAC,uDAAuD,CAAC,CAAA;AACrE,UAAA,OAAA;AACF,SAAA;QACA,MAAMC,sBAAsB,GAAGP,YAAY,CAACQ,gBAAgB,CAAC,CAAA,UAAA,EAAaf,MAAM,CAAA,EAAA,CAAI,CAAC,CAAA;AACrF,QAAA,IAAIc,sBAAsB,IAAIA,sBAAsB,CAAC,CAAC,CAAC,EAAE;UACvDA,sBAAsB,CAAC,CAAC,CAAC,CAACE,SAAS,GAAG3C,kBAAkB,CAAC0B,QAAQ,CAAC,CAAA;AACpE,SAAA;AACA,QAAA,MAAA;AACF,OAAA;AAAC,GAAA;AACH,CAAC,CAAA;AAED,MAAMkB,KAAK,GAAGA,CAACC,OAAO,EAAEC,YAAY,KAAK;AACvC,EAAA,OAAOnD,SAAS,CAAC,CAAGkD,EAAAA,OAAO,IAAI7D,UAAU,CAAA,CAAE,EAAE8D,YAAY,CAACjD,kBAAkB,CAAC,CAC1EkD,IAAI,CAAC,MAAM;AACV,IAAA,MAAMC,uBAAuB,GAAG,CAAGH,EAAAA,OAAO,CAAIC,CAAAA,EAAAA,YAAY,CAACG,eAAe,CAAIH,CAAAA,EAAAA,YAAY,CAACI,UAAU,CAAE,CAAA,CAAA;IACvG,OAAOnD,WAAW,CAACiD,uBAAuB,EAAEF,YAAY,CAACjD,kBAAkB,CAAC,CACzEkD,IAAI,CAAC,MAAM;MACVD,YAAY,CAACK,SAAS,GAAG,IAAI,CAAA;AAC/B,KAAC,CAAC,CAAA;AACN,GAAC,CAAC,CACDC,KAAK,CAAC,MAAM;AACXb,IAAAA,MAAM,CAACC,KAAK,CAAC,CAA6DK,0DAAAA,EAAAA,OAAO,GAAG,CAAC,CAAA;IACrF,OAAOpD,gBAAC,CAAC4D,QAAQ,EAAE,CAACC,MAAM,EAAE,CAAA;AAC9B,GAAC,CAAC,CAAA;AACN,CAAC,CAAA;AAEYC,MAAAA,0BAA0B,GAAIrD,OAAO,IAAK;AACrD,EAAA,OAAOA,OAAO,CAACsD,iBAAiB,IAC3BtD,OAAO,CAACsD,iBAAiB,CAACC,KAAK,IAC/BvD,OAAO,CAACsD,iBAAiB,CAACC,KAAK,CAAC9B,MAAM,CAAA;AAC7C,EAAC;AAEY+B,MAAAA,2BAA2B,GAAIF,iBAAiB,IAAK;AAChE,EAAA,OAAOA,iBAAiB,IAAIA,iBAAiB,CAACG,eAAe,KAAK,UAAU,CAAA;AAC9E,EAAC;AAEYC,MAAAA,uBAAuB,GAAIJ,iBAAiB,IAAK;AAC5D,EAAA,MAAMK,MAAM,GAAGL,iBAAiB,CAACK,MAAM,CAAA;AACvC,EAAA,MAAMC,KAAK,GAAGN,iBAAiB,CAACM,KAAK,CAAA;AACrC,EAAA,MAAMC,cAAc,GAAGD,KAAK,CAACE,MAAM,CAAA;EACnC,IAAIC,eAAe,GAAG,CAAC,CAAA;AACvB,EAAA,MAAMnB,YAAY,GAAG;IACnBG,eAAe,EAAEO,iBAAiB,CAACP,eAAe;IAClDC,UAAU,EAAGM,iBAAiB,CAAC7B,MAAM;IACrC9B,kBAAkB,EAAE2D,iBAAiB,CAAC3D,kBAAkB;AACxDsD,IAAAA,SAAS,EAAE,KAAA;GACZ,CAAA;AAED,EAAA,IAAIe,UAAU,GAAGC,OAAO,CAACC,OAAO,EAAE,CAAA;AAClC,EAAA,MAAMC,QAAQ,GAAGP,KAAK,CAACQ,GAAG,CAAEC,IAAI,IAAK,CAAGV,EAAAA,MAAM,CAAIU,CAAAA,EAAAA,IAAI,EAAE,CAAC,CAAA;AACzDF,EAAAA,QAAQ,CAACG,OAAO,CAAC3B,OAAO,IAAI;AAC1B;IACA,IAAIC,YAAY,CAACK,SAAS,EAAE;AAC1B,MAAA,OAAA;AACF,KAAA;AACAe,IAAAA,UAAU,GAAGA,UAAU,CAACnB,IAAI,CAAC,MAAMH,KAAK,CAACC,OAAO,EAAEC,YAAY,CAAC,CAAC,CAACM,KAAK,CAAC,MAAM;AAC3Ea,MAAAA,eAAe,IAAI,CAAC,CAAA;AACpB1B,MAAAA,MAAM,CAACC,KAAK,CAAC,CAAsCK,mCAAAA,EAAAA,OAAO,GAAG,CAAC,CAAA;MAC9D,IAAIoB,eAAe,IAAIF,cAAc,IAAI,CAACjB,YAAY,CAACK,SAAS,EAAE;AAChEZ,QAAAA,MAAM,CAACC,KAAK,CAAC,0EAA0E,CAAC,CAAA;QACxFf,gCAAgC,CAAC+B,iBAAiB,CAAC9B,QAAQ,EAAE8B,iBAAiB,CAAC7B,MAAM,CAAC,CAAA;AACxF,OAAA;AACF,KAAC,CAAC,CAAA;AACJ,GAAC,CAAC,CAAA;AACJ;;;;"}