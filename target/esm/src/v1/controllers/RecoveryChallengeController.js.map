{"version":3,"file":"RecoveryChallengeController.js","sources":["../../../../../src/v1/controllers/RecoveryChallengeController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc, View } from '@okta/courage';\nimport hbs from '@okta/handlebars-inline-precompile';\nimport Enums from 'util/Enums';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport FooterSignout from 'v1/views/shared/FooterSignout';\nimport TextBox from 'v1/views/shared/TextBox';\nexport default FormController.extend({\n  className: 'recovery-challenge',\n  Model: {\n    props: {\n      passCode: ['string', true],\n    },\n    local: {\n      ableToResend: 'boolean',\n    },\n    resendCode: function() {\n      // Note: This does not require a trapAuthResponse because Backbone's\n      // router will not navigate if the url path is the same\n      this.limitResending();\n      return this.doTransaction(function(transaction) {\n        return transaction.resend();\n      });\n    },\n    limitResending: function() {\n      this.set({ ableToResend: false });\n      _.delay(_.bind(this.set, this), Enums.API_RATE_LIMIT, { ableToResend: true });\n    },\n    save: function() {\n      return this.doTransaction(function(transaction) {\n        return transaction.verify({\n          passCode: this.get('passCode'),\n        });\n      });\n    },\n  },\n  Form: {\n    autoSave: true,\n    save: _.partial(loc, 'mfa.challenge.verify', 'login'),\n    title: function() {\n      if (this.options.appState.get('factorType') === Enums.RECOVERY_FACTOR_TYPE_CALL) {\n        return loc('recoveryChallenge.call.title', 'login');\n      } else {\n        return loc('recoveryChallenge.sms.title', 'login');\n      }\n    },\n    className: 'recovery-challenge',\n    initialize: function() {\n      this.listenTo(this.model, 'error', function() {\n        this.clearErrors();\n      });\n    },\n    formChildren: function() {\n      return [\n        FormType.Button({\n          title: loc('mfa.resendCode', 'login'),\n          attributes: { 'data-se': 'resend-button' },\n          className: 'button sms-request-button margin-top-30',\n          click: function() {\n            this.model.resendCode();\n          },\n          initialize: function() {\n            this.listenTo(this.model, 'change:ableToResend', function(model, ableToResend) {\n              if (ableToResend) {\n                this.options.title = loc('mfa.resendCode', 'login');\n                this.enable();\n                this.render();\n              } else {\n                this.options.title = loc('mfa.sent', 'login');\n                this.disable();\n                this.render();\n              }\n            });\n          },\n        }),\n        FormType.Input({\n          label: loc('mfa.challenge.enterCode.placeholder', 'login'),\n          'label-top': true,\n          className: 'enroll-sms-phone',\n          name: 'passCode',\n          input: TextBox,\n          type: 'text',\n        }),\n      ];\n    },\n  },\n\n  events: {\n    'click .send-email-link': function(e) {\n      e.preventDefault();\n      const settings = this.model.settings;\n      const username = this.options.appState.get('username');\n      const recoveryType = this.options.appState.get('recoveryType');\n\n      this.model.startTransaction(function(authClient) {\n        // The user could have landed here via the Forgot Password/Unlock Account flow\n        switch (recoveryType) {\n        case Enums.RECOVERY_TYPE_PASSWORD:\n          return authClient.forgotPassword({\n            username: settings.transformUsername(username, Enums.FORGOT_PASSWORD),\n            factorType: Enums.RECOVERY_FACTOR_TYPE_EMAIL,\n          });\n        case Enums.RECOVERY_TYPE_UNLOCK:\n          return authClient.unlockAccount({\n            username: settings.transformUsername(username, Enums.UNLOCK_ACCOUNT),\n            factorType: Enums.RECOVERY_FACTOR_TYPE_EMAIL,\n          });\n        default:\n          return;\n        }\n      })\n        .catch(() => {});\n    },\n  },\n\n  initialize: function() {\n    const recoveryType = this.options.appState.get('recoveryType');\n    let sendEmailLink;\n\n    switch (recoveryType) {\n    case Enums.RECOVERY_TYPE_PASSWORD:\n      sendEmailLink = hbs`{{i18n code=\"password.forgot.code.notReceived\" bundle=\"login\"}}`;\n      break;\n    case Enums.RECOVERY_TYPE_UNLOCK:\n      sendEmailLink = hbs`{{i18n code=\"account.unlock.code.notReceived\" bundle=\"login\"}}`;\n      break;\n    default:\n      break;\n    }\n\n    if (sendEmailLink && this.settings.get('features.emailRecovery')) {\n      this.add(\n        View.extend({\n          className: 'link send-email-link',\n          tagName: 'a',\n          attributes: {\n            href: '#',\n            'data-se': 'send-email-link',\n          },\n          template: sendEmailLink,\n        })\n      );\n    }\n\n    if (!this.settings.get('features.hideBackToSignInForReset')) {\n      this.addFooter(FooterSignout);\n    }\n  },\n\n  postRender: function() {\n    this.model.limitResending();\n  },\n});\n"],"names":["FormController","extend","className","Model","props","passCode","local","ableToResend","resendCode","limitResending","doTransaction","transaction","resend","set","_","delay","bind","Enums","API_RATE_LIMIT","save","verify","get","Form","autoSave","partial","loc","title","options","appState","RECOVERY_FACTOR_TYPE_CALL","initialize","listenTo","model","clearErrors","formChildren","FormType","Button","attributes","click","enable","render","disable","Input","label","name","input","TextBox","type","events","e","preventDefault","settings","username","recoveryType","startTransaction","authClient","RECOVERY_TYPE_PASSWORD","forgotPassword","transformUsername","FORGOT_PASSWORD","factorType","RECOVERY_FACTOR_TYPE_EMAIL","RECOVERY_TYPE_UNLOCK","unlockAccount","UNLOCK_ACCOUNT","catch","sendEmailLink","_Handlebars2","template","main","container","depth0","helpers","partials","data","lookupProperty","parent","propertyName","Object","prototype","hasOwnProperty","call","undefined","escapeExpression","hooks","helperMissing","nullContext","add","View","tagName","href","addFooter","FooterSignout","postRender"],"mappings":"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"}